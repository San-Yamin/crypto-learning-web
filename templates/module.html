{% extends "base.html" %}

{% block content %}
<div class="mission-panel container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center gap-3">
            <div>
                <h2 class="mb-0"><span class="blink">></span> MODULE {{ module_id }}: {{ module.title }}</h2>
                <p class="protocol-type mb-0 mt-1">PROTOCOL: {{ module.type|upper }}</p>
            </div>
            <div class="flex-shrink-0">
                <a href="{{ url_for('index') }}" class="text-nowrap" style="color: var(--text-color); text-decoration: none;">[ RETURN TO DASHBOARD ]</a>
            </div>
        </div>
    </div>

    <hr style="border-color: #333; margin: 20px 0;">

    <div class="row">
        <!-- LEFT COLUMN: THEORY & TOOLING -->
        <div class="col-lg-6 mb-4">
            <!-- SECTION 1: THEORY -->
            <div class="theory-section mb-5">
                <h3>THEORETICAL BASIS</h3>
                <p style="font-size: 1.1rem; line-height: 1.6;">{{ module.theory }}</p>
            </div>

            <!-- SECTION 2: TOOLING -->
            <div class="tooling-section">
                <h3>REQUIRED TOOLING</h3>
                <p>Use the following external tool to analyze the intercepted data:</p>
                <a href="{{ module.external_tool_url }}" target="_blank" class="tool-btn d-inline-block">
                    [ LAUNCH {{ module.tool_name|upper }} ] <span style="font-size: 0.8rem;">↗</span>
                </a>
                {% if module.reference_links %}
                    <div class="mt-4">
                        <h4 style="color: var(--accent-color);">REFERENCE MATERIALS</h4>
                        <ul class="list-unstyled mb-0">
                            {% for ref in module.reference_links %}
                                <li class="mb-2">
                                    <a href="{{ ref.url }}" target="_blank" style="color: var(--text-color); text-decoration: none;">
                                        [ {{ ref.label }} ] <span style="font-size: 0.8rem;">↗</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT COLUMN: MISSION -->
        <div class="col-lg-6">
            <!-- SECTION 3: THE MISSION -->
            <div class="mission-section p-3" style="background: rgba(0,0,0,0.3); border: 1px solid var(--border-color);">
                <h3>THE MISSION</h3>
                <p>Analyze the data below using the tool and find the flag.</p>
        
                <div class="challenge-content my-3 p-3" style="background: #000; border: 1px solid #333;">
                    <h5 style="color: var(--accent-color);">INTERCEPTED DATA:</h5>
                    
                    {% if module.type == 'rsa' %}
                        <div class="rsa-panel" style="font-family: monospace;">
                            <p>PUBLIC KEY PARAMETERS:</p>
                            <ul>
                                <li>p = {{ module.mission_cipher.p }}</li>
                                <li>q = {{ module.mission_cipher.q }}</li>
                                <li>e = {{ module.mission_cipher.e }}</li>
                            </ul>
                            <p style="color: var(--warning-color);">OBJECTIVE: CALCULATE PRIVATE KEY (d)</p>
                        </div>
                    {% elif module.type == 'steganography' %}
                         <!-- Keeping backward compatibility just in case, though not in new data -->
                        <div style="text-align: center;">
                            <img src="{{ module.mission_cipher }}" alt="Suspicious Image" style="max-width: 100%; border: 1px solid var(--accent-color);">
                        </div>
                    {% else %}
                        <!-- Default Text Display -->
                        <div style="word-break: break-all;">
                            <code style="color: var(--warning-color); font-size: 1.1rem; display: block; margin-top: 10px;">{{ module.mission_cipher }}</code>
                        </div>
                    {% endif %}
                </div>
        
                <div class="input-area mt-4">
                    <form id="moduleForm">
                        <label for="answer" class="form-label">ENTER DECRYPTED FLAG / ANSWER:</label>
                        <div class="input-group mb-3">
                            <input type="text" id="answer" name="answer" class="form-control" placeholder="Type answer here..." autocomplete="off" style="background: #000; color: var(--text-color); border: 1px solid var(--accent-color);">
                            <button type="submit" id="submitBtn" class="btn btn-outline-success" style="border-radius: 0;">VERIFY</button>
                        </div>
                    </form>
                    <div id="feedback" class="feedback"></div>
                </div>
        
                <div class="hints-section mt-4">
                     <button class="hint-btn" onclick="toggleHint()">[ SHOW HINT ]</button>
                     <div id="hint-display" class="hint mt-2">{{ module.hint }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .tool-btn {
        display: inline-block;
        background: transparent;
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 15px 30px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s;
        margin-top: 10px;
    }
    .tool-btn:hover {
        background: var(--accent-color);
        color: #000;
        box-shadow: 0 0 15px var(--accent-color);
    }
    /* Bootstrap Overrides for Dark Theme */
    .form-control:focus {
        background: #000;
        color: var(--text-color);
        border-color: var(--text-color);
        box-shadow: 0 0 5px var(--accent-color);
    }
</style>

<script>
    function toggleHint() {
        const hintEl = document.getElementById('hint-display');
        hintEl.classList.toggle('visible');
    }

    document.getElementById('moduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const answer = document.getElementById('answer').value;
        const btn = document.getElementById('submitBtn');
        const feedback = document.getElementById('feedback');
        
        btn.disabled = true;
        btn.innerText = "VERIFYING...";
        feedback.innerText = "RUNNING VERIFICATION...";
        feedback.className = "feedback";

        fetch("{{ url_for('module', module_id=module_id) }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: "answer=" + encodeURIComponent(answer)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                btn.innerText = "ACCESS GRANTED";
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
                feedback.innerText = "ACCESS GRANTED. GOOD WORK.";
                feedback.className = "feedback success";
                
                setTimeout(() => {
                     btn.disabled = false;
                     btn.innerText = "VERIFY";
                     btn.classList.remove('btn-success');
                     btn.classList.add('btn-outline-success');
                }, 3000);
            } else {
                btn.disabled = false;
                btn.innerText = "VERIFY";
                feedback.innerText = "ACCESS DENIED. " + data.message;
                feedback.className = "feedback error";
                
                document.querySelector('.input-area').animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
            }
        })
        .catch(err => {
            console.error(err);
            btn.disabled = false;
            btn.innerText = "VERIFY";
            feedback.innerText = "SYSTEM ERROR.";
        });
    });
</script>
{% endblock %}
